{% extends 'base.html' %}
{% load report_extras %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Statistics Report</h2>
        <a href="{% url 'dashboard-overview' %}" class="btn btn-glass"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>
    <div class="d-flex justify-content-end mb-3">
        <a href="{% url 'statistics-report-export' format='excel' %}" class="btn btn-outline-success me-2"><i class="fas fa-file-excel"></i> Export Excel</a>
        <a href="{% url 'statistics-report-export' format='pdf' %}" class="btn btn-outline-danger me-2"><i class="fas fa-file-pdf"></i> Export PDF</a>
        <a href="{% url 'statistics-report-export' format='csv' %}" class="btn btn-outline-primary"><i class="fas fa-file-csv"></i> Export CSV</a>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card glass-card shadow-lg p-4">
                <div class="row g-4">
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-box fa-2x mb-2"></i>
                        <div class="fw-bold">Products</div>
                        <div class="fs-4">{{ total_products }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-arrow-down fa-2x mb-2"></i>
                        <div class="fw-bold">Stock In</div>
                        <div class="fs-4">{{ total_stock_in }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-arrow-up fa-2x mb-2"></i>
                        <div class="fw-bold">Stock Out</div>
                        <div class="fs-4">{{ total_stock_out }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-warehouse fa-2x mb-2"></i>
                        <div class="fw-bold">Current Stock</div>
                        <div class="fs-4">{{ current_stock }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-truck-moving fa-2x mb-2"></i>
                        <div class="fw-bold">Total Rentals</div>
                        <div class="fs-4">{{ total_rentals }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <div class="fw-bold">Active Rentals</div>
                        <div class="fs-4">{{ active_rentals }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <div class="fw-bold">Overdue Rentals</div>
                        <div class="fs-4">{{ overdue_rentals }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-sliders-h fa-2x mb-2"></i>
                        <div class="fw-bold">Adjustments</div>
                        <div class="fs-4">{{ total_adjustments }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-bell fa-2x mb-2"></i>
                        <div class="fw-bold">Alerts</div>
                        <div class="fs-4">{{ total_alerts }}</div>
                    </div>
                    <div class="col-6 col-md-4 text-center">
                        <i class="fas fa-bell-exclamation fa-2x mb-2"></i>
                        <div class="fw-bold">Active Alerts</div>
                        <div class="fs-4">{{ active_alerts }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card glass-card p-3">
                <h5 class="fw-bold mb-3">Products by Category</h5>
                <canvas id="categoryPieChart"></canvas>
                <table class="table table-sm mt-3">
                    <thead><tr><th>Category</th><th>Count</th></tr></thead>
                    <tbody>
                    {% for c in category_breakdown %}
                        <tr><td>{{ c.name }}</td><td>{{ c.product_count }}</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card glass-card p-3">
                <h5 class="fw-bold mb-3">Stock In/Out by Month</h5>
                <canvas id="stockBarChart"></canvas>
                <table class="table table-sm mt-3">
                    <thead><tr><th>Month</th><th>Stock In</th><th>Stock Out</th></tr></thead>
                    <tbody>
                    {% for m in month_labels %}
                        <tr>
                            <td>{{ m }}</td>
                            <td>{{ stock_in_by_month|index:forloop.counter0 }}</td>
                            <td>{{ stock_out_by_month|index:forloop.counter0 }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card glass-card p-3">
                <h5 class="fw-bold mb-3">Rentals by Status</h5>
                <canvas id="rentalStatusBarChart"></canvas>
                <table class="table table-sm mt-3">
                    <thead><tr><th>Status</th><th>Count</th></tr></thead>
                    <tbody>
                    {% for r in rental_status_breakdown %}
                        <tr><td>{{ r.status|title }}</td><td>{{ r.count }}</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card glass-card p-3">
                <h5 class="fw-bold mb-3">Rentals by Product (Top 10)</h5>
                <canvas id="rentalProductBarChart"></canvas>
                <table class="table table-sm mt-3">
                    <thead><tr><th>Product</th><th>Count</th></tr></thead>
                    <tbody>
                    {% for r in rental_product_breakdown %}
                        <tr><td>{{ r.product__name }}</td><td>{{ r.count }}</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card glass-card p-3">
                <h5 class="fw-bold mb-3">Alerts by Type</h5>
                <canvas id="alertTypeBarChart"></canvas>
                <table class="table table-sm mt-3">
                    <thead><tr><th>Type</th><th>Count</th></tr></thead>
                    <tbody>
                    {% for a in alert_type_breakdown %}
                        <tr><td>{{ a.alert_type|title }}</td><td>{{ a.count }}</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card glass-card p-3">
                <h5 class="fw-bold mb-3">Alerts by Product (Top 10)</h5>
                <canvas id="alertProductBarChart"></canvas>
                <table class="table table-sm mt-3">
                    <thead><tr><th>Product</th><th>Count</th></tr></thead>
                    <tbody>
                    {% for a in alert_product_breakdown %}
                        <tr><td>{{ a.product__name }}</td><td>{{ a.count }}</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<style>
.glass-card {
    background: rgba(255,255,255,0.15);
    border-radius: 1.5rem;
    box-shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.18);
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Pie chart for product categories
const categoryPieChart = new Chart(document.getElementById('categoryPieChart'), {
    type: 'pie',
    data: {
        labels: {{ category_names|safe }},
        datasets: [{
            data: {{ category_counts|safe }},
            backgroundColor: [
                '#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ab'
            ]
        }]
    }
});
// Bar chart for stock in/out by month
const stockBarChart = new Chart(document.getElementById('stockBarChart'), {
    type: 'bar',
    data: {
        labels: {{ month_labels|safe }},
        datasets: [
            {
                label: 'Stock In',
                data: {{ stock_in_by_month|safe }},
                backgroundColor: '#4e79a7'
            },
            {
                label: 'Stock Out',
                data: {{ stock_out_by_month|safe }},
                backgroundColor: '#e15759'
            }
        ]
    },
    options: {responsive: true, plugins: {legend: {position: 'top'}}}
});
// Bar chart for rentals by status
const rentalStatusBarChart = new Chart(document.getElementById('rentalStatusBarChart'), {
    type: 'bar',
    data: {
        labels: {{ rental_status_labels|safe }},
        datasets: [{
            label: 'Count',
            data: {{ rental_status_counts|safe }},
            backgroundColor: '#59a14f'
        }]
    }
});
// Bar chart for rentals by product
const rentalProductBarChart = new Chart(document.getElementById('rentalProductBarChart'), {
    type: 'bar',
    data: {
        labels: {{ rental_product_names|safe }},
        datasets: [{
            label: 'Count',
            data: {{ rental_product_counts|safe }},
            backgroundColor: '#af7aa1'
        }]
    }
});
// Bar chart for alerts by type
const alertTypeBarChart = new Chart(document.getElementById('alertTypeBarChart'), {
    type: 'bar',
    data: {
        labels: {{ alert_type_labels|safe }},
        datasets: [{
            label: 'Count',
            data: {{ alert_type_counts|safe }},
            backgroundColor: '#f28e2b'
        }]
    }
});
// Bar chart for alerts by product
const alertProductBarChart = new Chart(document.getElementById('alertProductBarChart'), {
    type: 'bar',
    data: {
        labels: {{ alert_product_names|safe }},
        datasets: [{
            label: 'Count',
            data: {{ alert_product_counts|safe }},
            backgroundColor: '#bab0ab'
        }]
    }
});
</script>
{% endblock %} 